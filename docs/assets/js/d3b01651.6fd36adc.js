"use strict";(self.webpackChunkmydocs=self.webpackChunkmydocs||[]).push([[9921],{4735:(e,s,a)=>{a.r(s),a.d(s,{assets:()=>o,contentTitle:()=>l,default:()=>h,frontMatter:()=>c,metadata:()=>n,toc:()=>t});const n=JSON.parse('{"id":"Ciberseguridad/ElasticStack/elastic-search","title":"Elastic Serch","description":"Para comenzar a trabajar con el Stack de Elastic es necesario seguir una secuencia de instalaci\xf3n correcta, por ello se ha de comenzar con Elasticsearch.","source":"@site/docs/Ciberseguridad/ElasticStack/elastic-search.md","sourceDirName":"Ciberseguridad/ElasticStack","slug":"/Ciberseguridad/ElasticStack/elastic-search","permalink":"/me/docs/docs/Ciberseguridad/ElasticStack/elastic-search","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/Ciberseguridad/ElasticStack/elastic-search.md","tags":[],"version":"current","sidebarPosition":1,"frontMatter":{"sidebar_position":1,"title":"Elastic Serch"},"sidebar":"tutorialSidebar","previous":{"title":"IPtables","permalink":"/me/docs/docs/Ciberseguridad/Cortafuegos/practica-iptables"},"next":{"title":"Fleet y Elastic Agent","permalink":"/me/docs/docs/Ciberseguridad/ElasticStack/fleet-agent"}}');var r=a(4848),i=a(8453);const c={sidebar_position:1,title:"Elastic Serch"},l="ElasticSearch",o={},t=[{value:"ElasticSearch",id:"elasticsearch-1",level:2},{value:"Preparaci\xf3n del sistema",id:"preparaci\xf3n-del-sistema",level:3},{value:"Descarga de elasticsearch",id:"descarga-de-elasticsearch",level:3},{value:"Instalaci\xf3n de elasticsearch",id:"instalaci\xf3n-de-elasticsearch",level:3},{value:"Resultado instalaci\xf3n",id:"resultado-instalaci\xf3n",level:4},{value:"Soluciones de problemas",id:"soluciones-de-problemas",level:3},{value:"Obtener informaci\xf3n sobre la instalaci\xf3n",id:"obtener-informaci\xf3n-sobre-la-instalaci\xf3n",level:4},{value:"Problemas de activaci\xf3n de la aplicaci\xf3n",id:"problemas-de-activaci\xf3n-de-la-aplicaci\xf3n",level:4},{value:"Problemas con password de inicio",id:"problemas-con-password-de-inicio",level:4},{value:"Comprobar acceso Comprobar el acceso desde la terminal y conseguir",id:"comprobar-acceso-comprobar-el-acceso-desde-la-terminal-y-conseguir",level:4},{value:"Cambiar contrase\xf1a (opcional)",id:"cambiar-contrase\xf1a-opcional",level:4},{value:"Certificados y confianza",id:"certificados-y-confianza",level:4},{value:"Problemas con el <strong>cortafuegos</strong> en <strong>GNU/Linux</strong>.",id:"problemas-con-el-cortafuegos-en-gnulinux",level:4},{value:"Comprobaci\xf3n de los <strong>logs</strong> en tiempo real",id:"comprobaci\xf3n-de-los-logs-en-tiempo-real",level:4},{value:"Comprobar el <strong>estado de salud</strong> de <em>elastic</em>",id:"comprobar-el-estado-de-salud-de-elastic",level:4},{value:"Ajustar la memoria",id:"ajustar-la-memoria",level:4}];function d(e){const s={admonition:"admonition",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.R)(),...e.components},{Details:a}=s;return a||function(e,s){throw new Error("Expected "+(s?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}("Details",!0),(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(s.header,{children:(0,r.jsx)(s.h1,{id:"elasticsearch",children:"ElasticSearch"})}),"\n",(0,r.jsxs)(s.p,{children:["Para comenzar a trabajar con el ",(0,r.jsx)(s.strong,{children:"Stack de Elastic"})," es necesario seguir una secuencia de instalaci\xf3n correcta, por ello se ha de comenzar con ",(0,r.jsx)(s.strong,{children:"Elasticsearch"}),"."]}),"\n",(0,r.jsx)(s.h2,{id:"elasticsearch-1",children:"ElasticSearch"}),"\n",(0,r.jsx)(s.h3,{id:"preparaci\xf3n-del-sistema",children:"Preparaci\xf3n del sistema"}),"\n",(0,r.jsx)(s.p,{children:"Antes de comenzar con su instalaci\xf3n como es habitual conviene actualizar el OS"}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{children:"sudo apt update && sudo apt upgrade -y\n"})}),"\n",(0,r.jsxs)(s.p,{children:["Una vez actualizado el sistema operativo se procede a instalar ",(0,r.jsx)(s.strong,{children:"Java"})," ya que es necesario como base de la suite ",(0,r.jsx)(s.strong,{children:"ELK"}),"."]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{children:"sudo apt install openjdk-17-jdk -y\n"})}),"\n",(0,r.jsx)(s.h3,{id:"descarga-de-elasticsearch",children:"Descarga de elasticsearch"}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.strong,{children:"Elasticsearch"})," se puede descargar de varias formas, pero en este caso la opci\xf3n escogida es por ",(0,r.jsx)(s.strong,{children:"terminal"}),", para llevar a cabo esta descarga de forma segura es necesaria obtener la ",(0,r.jsx)(s.strong,{children:"clave p\xfablica GPG"}),"."]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{children:"wget -qO - https://artifacts.elastic.co/GPG-KEY-elasticsearch | sudo gpg --dearmor -o /usr/share/keyrings/elasticsearch-keyring.gpg\n"})}),"\n",(0,r.jsxs)(s.p,{children:["Una vez obtenida la ",(0,r.jsx)(s.strong,{children:"clave GPG"})," se procede a a\xf1adir el repositorio externo para la descarga de ",(0,r.jsx)(s.strong,{children:"elasticsearch"})," a los repositorios del OS."]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{children:'echo "deb [signed-by=/usr/share/keyrings/elasticsearch-keyring.gpg] https://artifacts.elastic.co/packages/8.x/apt stable main" | sudo tee /etc/apt/sources.list.d/elastic-8.x.list\n'})}),"\n",(0,r.jsx)(s.h3,{id:"instalaci\xf3n-de-elasticsearch",children:"Instalaci\xf3n de elasticsearch"}),"\n",(0,r.jsxs)(s.p,{children:["Una vez configurados los repositorios se procede a ",(0,r.jsx)(s.strong,{children:"actualizar el OS"})," y a realizar la instalaci\xf3n de ",(0,r.jsx)(s.strong,{children:"elasticsearch"}),"."]}),"\n",(0,r.jsxs)(s.admonition,{title:"Path de instalaci\xf3n",type:"warning",children:[(0,r.jsx)(s.p,{children:"Es importante instalar en la siguiente ruta."}),(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{children:"/opt/elastic/agent/data/\n"})})]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{children:"sudo apt update \r\nsudo apt install elasticsearch -y\n"})}),"\n",(0,r.jsx)(s.h4,{id:"resultado-instalaci\xf3n",children:"Resultado instalaci\xf3n"}),"\n",(0,r.jsx)(s.admonition,{title:"Atenci\xf3n a la consola durante la instalaci\xf3n",type:"warning",children:(0,r.jsx)(s.p,{children:"Una vez realizada la instalaci\xf3n es muy importante prestar atenci\xf3n al resultado recibido por consola, ya que se proporciona una contrase\xf1a."})}),"\n",(0,r.jsxs)(a,{children:[(0,r.jsx)("summary",{children:(0,r.jsx)(s.p,{children:"Informaci\xf3n de seguridad importante en la salida por consola al finalizar la instalaci\xf3n"})}),(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{children:"Authentication and authorization are enabled. **TLS** for the transport\r\nand **HTTP layers** is enabled and configured.\r\n\r\nThe **generated password** for the elastic built-in **superuser** is:\r\n**J3q11Z4lUB7Vv8f5ioMh**\r\n\r\nIf this node should join an existing cluster, you can reconfigure this\r\nwith *'/usr/share/elasticsearch/bin/elasticsearch-reconfigure-node\r\n--enrollment-token \"token-here\"'* after creating an enrollment token on\r\nyour existing cluster.\r\n\r\nYou can complete the following actions at any time:\r\n\r\n**Reset the password** of the elastic built-in **superuser** with\r\n*'/usr/share/elasticsearch/bin/elasticsearch-reset-password -u\r\nelastic'*.\r\n\r\n**Generate an enrollment token** for **Kibana instances** with\r\n*'/usr/share/elasticsearch/bin/elasticsearch-create-enrollment-token -s\r\nkibana'*.\r\n\r\n**Generate an enrollment token** for **Elasticsearch nodes** with\r\n*'/usr/share/elasticsearch/bin/elasticsearch-create-enrollment-token -s\r\nnode'*.\n"})})]}),"\n",(0,r.jsxs)(s.admonition,{title:"Versi\xf3n 8.x",type:"warning",children:[(0,r.jsxs)(s.p,{children:["A partir de ",(0,r.jsx)(s.strong,{children:"Elasticsearch 8.x"})," se activa seguridad por defecto ",(0,r.jsx)(s.em,{children:"(TLS + Autenticaci\xf3n)"}),"."]}),(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Autenticaci\xf3n obligatoria"}),": elastic ",(0,r.jsx)(s.em,{children:"(como superadmin)"})]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Comunicaci\xf3n cifrada SSL/TLS"})," ",(0,r.jsx)(s.em,{children:"(certificados auto generados)"})]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Enrollment tokens"}),": ",(0,r.jsxs)(s.em,{children:["para conectar ",(0,r.jsx)(s.strong,{children:"Kibana"})," o nuevosnodos al cluster"]}),"."]}),"\n"]})]}),"\n",(0,r.jsxs)(a,{children:[(0,r.jsx)("summary",{children:(0,r.jsxs)(s.p,{children:["Gesti\xf3n de las contrase\xf1as en ",(0,r.jsx)("b",{children:"ELK"})]})}),(0,r.jsxs)(s.p,{children:["La ",(0,r.jsx)(s.strong,{children:"contrase\xf1a inicial"})," de ",(0,r.jsx)(s.strong,{children:"elasticsearch"})," se almacena en la siguiente ruta."]}),(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{children:"var/lib/elasticsearch/initial_master_nodes.password\n"})}),(0,r.jsxs)(s.p,{children:["En caso de perdida de la misma se puede generar una ",(0,r.jsx)(s.strong,{children:"nueva contrase\xf1a"})," con el siguiente comando."]}),(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{children:"sudo /usr/share/elasticsearch/bin/elasticsearch-reset-password -u elastic\n"})})]}),"\n",(0,r.jsxs)(a,{children:[(0,r.jsx)("summary",{children:(0,r.jsx)(s.p,{children:"Enrollment tokens"})}),(0,r.jsxs)(s.p,{children:["Los ",(0,r.jsx)(s.strong,{children:"enrollment tokens"})," son ",(0,r.jsx)(s.em,{children:"tokens de duraci\xf3n temporal"})," para que\r\n",(0,r.jsx)(s.strong,{children:"Kibana"})," se pueda ",(0,r.jsx)(s.strong,{children:"unir"})," al ",(0,r.jsx)(s.em,{children:"cluster de elasticsearch"})," de forma\r\nsegura, poseen un ",(0,r.jsx)(s.strong,{children:"tiempo de vida"})," de ",(0,r.jsx)(s.strong,{children:"30 minutos"}),"."]}),(0,r.jsx)(s.p,{children:"Su mayor ventaja es la facilidad para integrar elascticsearch y kibana\r\nsin tener que usar certificados de forma manual."}),(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsx)(s.li,{children:(0,r.jsx)(s.strong,{children:"Creaci\xf3n de un enrollment token para un user Kibana"})}),"\n"]}),(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{children:"sudo /usr/share/elasticsearch/bin/elasticsearch-create-enrollment-token -s kibana\n"})}),(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsx)(s.li,{children:(0,r.jsx)(s.strong,{children:"Creaci\xf3n de un enrollment tolen para conectar nuevos nodos adicionales"})}),"\n"]}),(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{children:"sudo /usr/share/elasticsearch/bin/elasticsearch-create-enrollment-token -s kibana\n"})})]}),"\n",(0,r.jsxs)(s.p,{children:["Los ",(0,r.jsx)(s.strong,{children:"enrollment tokens"})," son la ",(0,r.jsx)(s.strong,{children:"mejor soluci\xf3n"})," cuando se instala\r\n",(0,r.jsx)(s.strong,{children:"Kibana"})," en un entorno ",(0,r.jsx)(s.strong,{children:"ElasticSearch"})," ",(0,r.jsx)(s.em,{children:"y no se quiere complicar la\r\nconfiguraci\xf3n a trav\xe9s de Certificados SSL"}),", el uso de credenciales\r\n",(0,r.jsx)(s.em,{children:"(usuario / contrase\xf1a)"})," de elasticsearch teniendo que editar el fichero\r\n",(0,r.jsx)(s.em,{children:"kibana.yml"}),"."]}),"\n",(0,r.jsxs)(s.p,{children:["Los problemas que pueden surgir para establecer la conexi\xf3n utilizando\r\nestos ",(0,r.jsx)(s.strong,{children:"enrollment tokens"})," son los siguientes:"]}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsx)(s.li,{children:"Token expirado"}),"\n",(0,r.jsxs)(s.li,{children:["Seguridad activa de ",(0,r.jsx)(s.strong,{children:"elastic search"})," pero Kibana no"]}),"\n",(0,r.jsxs)(s.li,{children:["Problema para reconocer certificados auto generados, para ello se usa\r\n",(0,r.jsx)(s.strong,{children:"--insecure"})," o ",(0,r.jsx)(s.strong,{children:"-k"})," con curl."]}),"\n"]}),"\n",(0,r.jsx)(s.h3,{id:"soluciones-de-problemas",children:"Soluciones de problemas"}),"\n",(0,r.jsx)(s.h4,{id:"obtener-informaci\xf3n-sobre-la-instalaci\xf3n",children:"Obtener informaci\xf3n sobre la instalaci\xf3n"}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{children:"sudo nano /etc/elasticsearch/elasticsearch.yml\r\n\r\n    cluster.name: my-elastic-cluster  # Nombre del cluster\r\n    node.name: my-parrot-node        # Nombre del nodo\r\n    network.host: 0.0.0.0            # Escuchar en todas las interfaces (ajustar seg\xfan necesidades)\r\n    discovery.type: single-node      # Modo single-node (Solo 1 servidor)\n"})}),"\n",(0,r.jsx)(s.h4,{id:"problemas-de-activaci\xf3n-de-la-aplicaci\xf3n",children:"Problemas de activaci\xf3n de la aplicaci\xf3n"}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{children:"sudo systemctl enable elasticsearch\r\nsudo systemctl start elasticsearch\n"})}),"\n",(0,r.jsx)(s.h4,{id:"problemas-con-password-de-inicio",children:"Problemas con password de inicio"}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{children:"sudo cat /var/lib/elasticsearch initial_master_nodes.password\n"})}),"\n",(0,r.jsx)(s.h4,{id:"comprobar-acceso-comprobar-el-acceso-desde-la-terminal-y-conseguir",children:"Comprobar acceso Comprobar el acceso desde la terminal y conseguir"}),"\n",(0,r.jsx)(s.p,{children:"de retorno el JSON con la informaci\xf3n"}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{children:'curl -u elastic:TUPASSWORD -X GET "https://localhost:9200" --insecure\n'})}),"\n",(0,r.jsx)(s.h4,{id:"cambiar-contrase\xf1a-opcional",children:"Cambiar contrase\xf1a (opcional)"}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{children:'curl -u elastic:TUPASSWORD -X POST "https://localhost:9200/_security/user/elastic/_password?pretty" -H "Content-Type: application/json" -d \'{"password": "nuevopassword"}\' --insecure\n'})}),"\n",(0,r.jsx)(s.h4,{id:"certificados-y-confianza",children:"Certificados y confianza"}),"\n",(0,r.jsxs)(s.p,{children:["Los certificados autogenerados ",(0,r.jsx)(s.strong,{children:"TLS"})," sealmacenan en el ",(0,r.jsx)(s.strong,{children:"path"})," de elasticsearch."]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{children:"/etc/elasticsearch/certs\n"})}),"\n",(0,r.jsxs)(s.p,{children:["Kibana y otros servicios deben de ",(0,r.jsx)(s.strong,{children:"confiar"})," en estos ",(0,r.jsx)(s.strong,{children:"certificados"}),",\r\nse ajustan las rutas en ",(0,r.jsx)(s.strong,{children:"kibana.yml"}),". Si siguen dando problemas una\r\nsoluci\xf3n temporal consiste en ",(0,r.jsx)(s.strong,{children:"desactivar"})," en ",(0,r.jsx)(s.em,{children:"elasticsearch.yml"})," la\r\n",(0,r.jsx)(s.em,{children:"seguridad"}),"."]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{children:"xpack.security.enabled: false\n"})}),"\n",(0,r.jsxs)(s.h4,{id:"problemas-con-el-cortafuegos-en-gnulinux",children:["Problemas con el ",(0,r.jsx)(s.strong,{children:"cortafuegos"})," en ",(0,r.jsx)(s.strong,{children:"GNU/Linux"}),"."]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{children:"sudo ufw allow 9200/tcp\r\nsudo ufw allow 9300/tcp\r\nsudo ufw reload\r\nsudo ufw allow 9200 # problemas ufw\n"})}),"\n",(0,r.jsxs)(s.h4,{id:"comprobaci\xf3n-de-los-logs-en-tiempo-real",children:["Comprobaci\xf3n de los ",(0,r.jsx)(s.strong,{children:"logs"})," en tiempo real"]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{children:"sudo journalctl -u elasticsearch -f\n"})}),"\n",(0,r.jsxs)(s.h4,{id:"comprobar-el-estado-de-salud-de-elastic",children:["Comprobar el ",(0,r.jsx)(s.strong,{children:"estado de salud"})," de ",(0,r.jsx)(s.em,{children:"elastic"})]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{children:'curl -u elastic:TUPASSWORD -X GET "https://localhost:9200/_cluster/health?pretty" --insecure\n'})}),"\n",(0,r.jsx)(s.h4,{id:"ajustar-la-memoria",children:"Ajustar la memoria"}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{children:"sudo nano /etc/elasticsearch/jvm.options \n"})})]})}function h(e={}){const{wrapper:s}={...(0,i.R)(),...e.components};return s?(0,r.jsx)(s,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}},8453:(e,s,a)=>{a.d(s,{R:()=>c,x:()=>l});var n=a(6540);const r={},i=n.createContext(r);function c(e){const s=n.useContext(i);return n.useMemo((function(){return"function"==typeof e?e(s):{...s,...e}}),[s,e])}function l(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:c(e.components),n.createElement(i.Provider,{value:s},e.children)}}}]);