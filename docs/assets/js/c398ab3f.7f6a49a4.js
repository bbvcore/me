"use strict";(self.webpackChunkmydocs=self.webpackChunkmydocs||[]).push([[6720],{7838:(e,n,a)=>{a.r(n),a.d(n,{assets:()=>d,contentTitle:()=>l,default:()=>u,frontMatter:()=>c,metadata:()=>s,toc:()=>o});const s=JSON.parse('{"id":"Ciberseguridad/VPN/openVPN","title":"Open VPN","description":"Instalaci\xf3n","source":"@site/docs/Ciberseguridad/VPN/openVPN.md","sourceDirName":"Ciberseguridad/VPN","slug":"/Ciberseguridad/VPN/openVPN","permalink":"/me/docs/docs/Ciberseguridad/VPN/openVPN","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/Ciberseguridad/VPN/openVPN.md","tags":[],"version":"current","sidebarPosition":2,"frontMatter":{"sidebar_position":2,"title":"Open VPN"},"sidebar":"tutorialSidebar","previous":{"title":"Arranque","permalink":"/me/docs/docs/Ciberseguridad/Security Onion/so-arranque"},"next":{"title":"Iconos","permalink":"/me/docs/docs/Gu\xeda/iconos"}}');var r=a(4848),i=a(8453);const c={sidebar_position:2,title:"Open VPN"},l="Open VPN",d={},o=[{value:"Instalaci\xf3n",id:"instalaci\xf3n",level:2},{value:"Infraestructua PKI",id:"infraestructua-pki",level:2},{value:"Ejecuci\xf3n VARS (m\xe9todo viejo)",id:"ejecuci\xf3n-vars-m\xe9todo-viejo",level:3},{value:"Ejecuci\xf3n actual (Easy-RSA 3)",id:"ejecuci\xf3n-actual-easy-rsa-3",level:3},{value:"Creaci\xf3n estructura base",id:"creaci\xf3n-estructura-base",level:4},{value:"Despliegue PKI",id:"despliegue-pki",level:4},{value:"Despliegue CA",id:"despliegue-ca",level:4},{value:"Clientes",id:"clientes",level:2},{value:"Creaci\xf3n OVPN",id:"creaci\xf3n-ovpn",level:3}];function t(e){const n={admonition:"admonition",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.R)(),...e.components},{Details:a}=n;return a||function(e,n){throw new Error("Expected "+(n?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}("Details",!0),(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"open-vpn",children:"Open VPN"})}),"\n",(0,r.jsx)(n.h2,{id:"instalaci\xf3n",children:"Instalaci\xf3n"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"sudo apt install openvpn easy-rsa -y\n"})}),"\n",(0,r.jsx)(n.h2,{id:"infraestructua-pki",children:"Infraestructua PKI"}),"\n",(0,r.jsx)(n.p,{children:"La infraestructura PKI es la infraestructura de clave p\xfablica."}),"\n",(0,r.jsx)(n.h3,{id:"ejecuci\xf3n-vars-m\xe9todo-viejo",children:"Ejecuci\xf3n VARS (m\xe9todo viejo)"}),"\n",(0,r.jsx)(n.p,{children:"Creaci\xf3n de la estructura base"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"make-cadir ~/openvpn-ca\ncd ~/openvpn-ca\n"})}),"\n",(0,r.jsx)(n.admonition,{title:"make-cadir",type:"tip",children:(0,r.jsx)(n.p,{children:"Se trata de un comando que sirve para genear una entidad CA local gracias a este comando perteneciente a Easy-RSA."})}),"\n",(0,r.jsx)(n.p,{children:"Una vez creado este directorio se dispone en su interior de los siguientes ficheros:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Scripts de Easy-RSA"}),"\n",(0,r.jsxs)(n.li,{children:["Entorno listo para claves y certificados\nEn las versiones anteriores, eran necesaria la ejecuci\xf3n del script ",(0,r.jsx)(n.strong,{children:"vars"}),", ejecutado con source para que su ejecuci\xf3n sea en la shell y su entorno actual, que es donde actua ",(0,r.jsx)(n.strong,{children:"source"})]}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"sudo source vars\n"})}),"\n",(0,r.jsx)(n.p,{children:"A continuaci\xf3n se ejecutaban otros 2 scripts, estos con ./ dado que as\xed se procede a crear procesos hijos de la shell actual. Esto se hac\xeda as\xed para la shell con source carga variables de entorno que los procesos hijos de los 2 siguientes scripts utilizan."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"./clean-all\n./build-ca\n"})}),"\n",(0,r.jsx)(n.h3,{id:"ejecuci\xf3n-actual-easy-rsa-3",children:"Ejecuci\xf3n actual (Easy-RSA 3)"}),"\n",(0,r.jsx)(n.h4,{id:"creaci\xf3n-estructura-base",children:"Creaci\xf3n estructura base"}),"\n",(0,r.jsx)(n.p,{children:"Para la ejecuci\xf3n del m\xe9todo actual, la versi\xf3n 3 de Easy-RSA, se crea la siguiente estructura, mediante la creaci\xf3n del directorio easy-rsa en el home del usuario y copiando los ficheros del directorio /usr/share necesarios para utilizar e inicializar la PKI con Easy-RSA 3."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"mkdir ~/easy-rsa\ncp -r /usr/share/easy-rsa/* ~/easy-rsa/\ncd #/easy-rsa\n"})}),"\n",(0,r.jsx)(n.h4,{id:"despliegue-pki",children:"Despliegue PKI"}),"\n",(0,r.jsx)(n.p,{children:"Una vez creada la estructura, se accede al directorio /easy-rsa/ y se ejecuta el comando necesario para el despliegue de la PKI generando la CA."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"./easy-rsa init-pki\n"})}),"\n",(0,r.jsx)(n.h4,{id:"despliegue-ca",children:"Despliegue CA"}),"\n",(0,r.jsxs)(n.p,{children:["A continuaci\xf3n, se despliega la ",(0,r.jsx)(n.strong,{children:"CA"})," con el siguiente comando."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"./easy-rsa build-ca\n"})}),"\n",(0,r.jsxs)(n.p,{children:["Entonces te pedir\xe1 2 datos, primero una ",(0,r.jsx)(n.strong,{children:"passphrase"})," y luego un nombre para el ",(0,r.jsx)(n.strong,{children:"CN"})," ",(0,r.jsx)(n.em,{children:"(commun name)"})," en este caso, como ejemplo, he utilizado ",(0,r.jsx)(n.strong,{children:"mi-vpn-ca"}),"."]}),"\n",(0,r.jsx)(n.p,{children:"Una vez finalizado este proceso se obtendra la siguiente direcci\xf3n donde est\xe1 alojado el certificado de CA."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"/home/<user>/easy-rsa/pki/ca.crt\n"})}),"\n",(0,r.jsx)(n.p,{children:"Ahora se procede a configurar un certificado y una clave para el servidor"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"./easyrsa gen-req server nopass\n"})}),"\n",(0,r.jsxs)(n.p,{children:["Entonces el OS pide un CN para identificarlo, dado que es el servidor, en este caso se usa ",(0,r.jsx)(n.strong,{children:"server"}),". A continuaci\xf3n nos muestra las rutas donde se generan la clave privada y la solicitud p\xfablica de certificado."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"/home/<user>/easy-rsa/pki/reqs/server.req\n/home/<user>/easy-rsa/pki/private/server.key\n"})}),"\n",(0,r.jsx)(n.p,{children:"Una vez se tiene la petici\xf3n del servidor se procede a firmarla"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"./easyrsa sign-req server server\n"})}),"\n",(0,r.jsx)(n.p,{children:"Se muestran los datos del CN y se pide otra passphrase para\nel certificado y se muestra el fichero de configuraci\xf3n usado"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"/home/<user>/easy-rsa/pki/openssl-easyrsa.conf\n"})}),"\n",(0,r.jsx)(n.p,{children:"Y tambi\xe9n el uso de la passphrase del fichero"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"/home/<user>/easy-rsa/pki/private/ca.key\n"})}),"\n",(0,r.jsx)(n.p,{children:"Y muestra la ruta de la creaci\xf3n del certificado, adem\xe1s de la fecha de validaci\xf3n (825 days)."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"/home/<user>/easy-rsa/pki/issued/server.crt\n"})}),"\n",(0,r.jsx)(n.p,{children:"Con todo esto ahora se ha de generar el Diffie-Hellman"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"./easy-rsa gen-dh\n"})}),"\n",(0,r.jsx)(n.p,{children:"Que posee un tama\xf1o de 2048 bits y esta accesible en la ruta siguiente"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"/home/<user>/easy-rsa/pki/dh.pem\n"})}),"\n",(0,r.jsx)(n.p,{children:"Y para finalizar, como paso opciona se crea la clave TLS-Auth"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"openvpn --genkey secret ta.key\n"})}),"\n",(0,r.jsx)(n.p,{children:"Esta ta.key se usa dentro del fichero de configuraci\xf3n del servidor server.conf y en el cliente dentro del .ovpn"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"tls-auth ta.key 0 # servidor\ntls-auth ta.key 1 # cliente\n"})}),"\n",(0,r.jsx)(n.p,{children:"La numeraci\xf3n 0/1 representa el modo de uso, la direcci\xf3n del canal HMAC."}),"\n",(0,r.jsx)(n.h2,{id:"clientes",children:"Clientes"}),"\n",(0,r.jsxs)(n.p,{children:["Hay que generar una solicitud y firmarla. Tambi\xe9n pide un CN, en este caso proporciono el del servidor, que era ",(0,r.jsx)(n.strong,{children:"server"}),". La duraci\xf3n tambi\xe9n es de 825 days)."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"./easyrsa gen-req clientN nopass # Genera clave privada y CSR para cliente\n"})}),"\n",(0,r.jsx)(n.p,{children:"Se obtiene clientN.key (clave privada) y clientN.req (CSR), que est\xe1n accesibles en las siguientes rutas."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"/home/<user>/easy-rsa/pki/reqs/clientN.req\n/home/<user>/easy-rsa/pki/private/clientN.key\n"})}),"\n",(0,r.jsx)(n.p,{children:"A continuaci\xf3n se procede a firmar la CSR. Se pide confirmaci\xf3n del sujeto CN y se pide una passphrase haciendo uso de la configuraci\xf3n de /easy-rsa/pki/openssl-easyrsa.cnf y la passphrase de /easy-rsa/pki/private/ca.key."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"./easyrsa sign-req client clientN # Firma la CSR con la CA del servidor y genera el certificado del cliente\n"})}),"\n",(0,r.jsx)(n.p,{children:"Y de esta forma se obtiene el certificado del cliente que est\xe1 disponible en la ruta siguiente"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"/home/<user>/easy-rsa/pki/issued/clientN.crt\n"})}),"\n",(0,r.jsx)(n.p,{children:"Con esto se obtiene todo lo necesario para que un cliente se pueda conectar:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"client.key: clave privada"}),"\n",(0,r.jsx)(n.li,{children:"client.crt: certificado firmado por la CA"}),"\n",(0,r.jsx)(n.li,{children:"ca.crt: certificado de la CA"}),"\n",(0,r.jsx)(n.li,{children:"ta.key: clave TLS-Auth compartida"}),"\n",(0,r.jsx)(n.li,{children:"clientN.ovpn: Configuraci\xf3n del cliente (todo embebido)"}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"creaci\xf3n-ovpn",children:"Creaci\xf3n OVPN"}),"\n",(0,r.jsx)(n.p,{children:"Recapitulando los ficheros necesarios son:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"ca.crt, en /pki/ca.crt, resultante de ejecutar la creaci\xf3n de la CA"}),"\n",(0,r.jsx)(n.li,{children:"clientN.crt, en /pki/issued/clientN.crt, resultante de ejecutar sign-req"}),"\n",(0,r.jsx)(n.li,{children:"clientN.key, en /pki/private/clientN.key, resultante de ejecutar gen-req clientN nopass"}),"\n",(0,r.jsx)(n.li,{children:"ta.key, resultante de ejecutar openvpn --genkey secret ta.key"}),"\n"]}),"\n",(0,r.jsxs)(a,{children:[(0,r.jsx)("summary",{children:(0,r.jsx)(n.p,{children:"Plantilla para la creaci\xf3n del fichero ovpn embebiendo los datos generados"})}),(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"cat > clientN.ovpn <<EOF\nclient\ndev tun\nproto udp\nremote <IP o Dominio del Server> 1194\nresolv-retry infinite\nnobind\npersist-key\npersist-tun\n\n<ca>\n$(cat pki/ca.crt)\n</ca>\n\n<cert>\n$(cat pki/issued/client1.crt)\n</cert>\n\n<key>\n$(cat pki/private/client1.key)\n</key>\n\n<tls-auth>\n$(cat ta.key)\n</tls-auth>\nkey-direction 1\n\ncipher AES-256-CBC\nauth SHA256\nverb 3\nEOF\n"})})]}),"\n",(0,r.jsx)(n.p,{children:'Y una vez se tiene el fichero OVPN, desde el cliente ejecutando "openvpn + fichero.ovpn" se accede al servidor por el tunneling.'})]})}function u(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(t,{...e})}):t(e)}},8453:(e,n,a)=>{a.d(n,{R:()=>c,x:()=>l});var s=a(6540);const r={},i=s.createContext(r);function c(e){const n=s.useContext(i);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:c(e.components),s.createElement(i.Provider,{value:n},e.children)}}}]);