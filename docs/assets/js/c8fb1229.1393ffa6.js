"use strict";(self.webpackChunkmydocs=self.webpackChunkmydocs||[]).push([[6196],{3868:(e,r,i)=>{i.r(r),i.d(r,{assets:()=>d,contentTitle:()=>a,default:()=>u,frontMatter:()=>t,metadata:()=>o,toc:()=>l});const o=JSON.parse('{"id":"OT/Ciberseguridad/ElasticStack/Despliegues/despliegue-iiot-broker","title":"Despliegue iiot-broker","description":"M\xe1quina desplegada con el OS base de GNU/Linux Ubuntu y el establecimiento de un servidor Mosquitto que actua como servidor broker.","source":"@site/docs/OT/Ciberseguridad/ElasticStack/Despliegues/despliegue-iiot-broker.md","sourceDirName":"OT/Ciberseguridad/ElasticStack/Despliegues","slug":"/OT/Ciberseguridad/ElasticStack/Despliegues/despliegue-iiot-broker","permalink":"/me/docs/docs/OT/Ciberseguridad/ElasticStack/Despliegues/despliegue-iiot-broker","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/OT/Ciberseguridad/ElasticStack/Despliegues/despliegue-iiot-broker.md","tags":[],"version":"current","sidebarPosition":3,"frontMatter":{"sidebar_position":3,"title":"Despliegue iiot-broker"},"sidebar":"tutorialSidebar","previous":{"title":"Despliegue Hist_db","permalink":"/me/docs/docs/OT/Ciberseguridad/ElasticStack/Despliegues/despliegue-hist_db"},"next":{"title":"Menu SO","permalink":"/me/docs/docs/OT/Ciberseguridad/Security Onion/intro"}}');var n=i(4848),s=i(8453);const t={sidebar_position:3,title:"Despliegue iiot-broker"},a="IIoT Broker",d={},l=[{value:"Mosquitto",id:"mosquitto",level:2},{value:"Test sin clientes desde terminal",id:"test-sin-clientes-desde-terminal",level:3},{value:"Cortafuegos",id:"cortafuegos",level:3},{value:"Ejemplo de uso",id:"ejemplo-de-uso",level:2},{value:"Fichero de configuraci\xf3n anterior a la versi\xf3n 2.0",id:"fichero-de-configuraci\xf3n-anterior-a-la-versi\xf3n-20",level:3},{value:"Fichero de configuraci\xf3n versi\xf3n 2.0 o superiores",id:"fichero-de-configuraci\xf3n-versi\xf3n-20-o-superiores",level:3},{value:"Ejemplo de testeo del fichero de configuraci\xf3n modificado en mv IIoT-broker",id:"ejemplo-de-testeo-del-fichero-de-configuraci\xf3n-modificado-en-mv-iiot-broker",level:3},{value:"Ejemplo de JSON para el payload en Arduino para el ESP32",id:"ejemplo-de-json-para-el-payload-en-arduino-para-el-esp32",level:3},{value:"En Telegraf",id:"en-telegraf",level:3},{value:"Test de Mosquitto a Telegraf",id:"test-de-mosquitto-a-telegraf",level:4},{value:"Comprobaci\xf3n en Telegraf",id:"comprobaci\xf3n-en-telegraf",level:4}];function c(e){const r={code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",p:"p",pre:"pre",...(0,s.R)(),...e.components},{Details:i}=r;return i||function(e,r){throw new Error("Expected "+(r?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}("Details",!0),(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(r.header,{children:(0,n.jsx)(r.h1,{id:"iiot-broker",children:"IIoT Broker"})}),"\n",(0,n.jsx)(r.p,{children:"M\xe1quina desplegada con el OS base de GNU/Linux Ubuntu y el establecimiento de un servidor Mosquitto que actua como servidor broker."}),"\n",(0,n.jsx)(r.h2,{id:"mosquitto",children:"Mosquitto"}),"\n",(0,n.jsx)(r.p,{children:"Se trata de un broker MQTT que utiliza el puerto est\xe1ndar 1883 para ejercer de broker."}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{children:"sudo apt update\r\nsudo apt install mosquitto mosquitto-clients\r\nsudo systemctl enable mosquitto\r\nsudo systemctl start mosquitto\r\nsudo systemctl status mosquitto\n"})}),"\n",(0,n.jsx)(r.h3,{id:"test-sin-clientes-desde-terminal",children:"Test sin clientes desde terminal"}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{children:'mosquitto_sub -t test\r\nmosquitto_pub -t test -m "Hola desde el broker"\n'})}),"\n",(0,n.jsx)(r.h3,{id:"cortafuegos",children:"Cortafuegos"}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{children:"sudo ufw allow 1883\n"})}),"\n",(0,n.jsx)(r.h2,{id:"ejemplo-de-uso",children:"Ejemplo de uso"}),"\n",(0,n.jsx)(r.h3,{id:"fichero-de-configuraci\xf3n-anterior-a-la-versi\xf3n-20",children:"Fichero de configuraci\xf3n anterior a la versi\xf3n 2.0"}),"\n",(0,n.jsx)(r.p,{children:"El fichero de configuraci\xf3n de Mosquitto est\xe1 ubicado en /etc/mosquitto y se llama mosquitto.conf."}),"\n",(0,n.jsxs)(i,{children:[(0,n.jsx)("summary",{children:(0,n.jsx)(r.p,{children:"Ejemplo de configuraci\xf3n para Mosquitto y un ESP32"})}),(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{children:"# File: mosquitto.conf\r\n# Estado: Base del proyecto IIoT \r\n\r\n# Listener en el puerto por defecto para MQTT\r\nlistener 1883\r\n\r\n# Direcci\xf3n de escucha (0.0.0.0 - cualquier origen)\r\nbind_address 0.0.0.0\r\n\r\n# Desactivar autenticaci\xf3n y TLS \r\nallow_anonymous true\r\npassword_file /dev/null\r\n\r\n# Logs para depuraci\xf3n\r\nlog_dest file /var/log/mosquitto/mosquitto.log\r\nlog_type error\r\nlog_type warning\r\nlog_type notice\r\nlog_type information\r\n\r\n# Persistencia en las sesiones\r\npersistence true\r\npersistence_location /var/lib/mosquitto/\r\n\n"})})]}),"\n",(0,n.jsx)(r.h3,{id:"fichero-de-configuraci\xf3n-versi\xf3n-20-o-superiores",children:"Fichero de configuraci\xf3n versi\xf3n 2.0 o superiores"}),"\n",(0,n.jsx)(r.p,{children:"Se comienza creando un fichero de configuraci\xf3n propio en la ruta /etc/mosquitto/mosquitto.d con el siguiente contenido."}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{children:"# Listener en el puerto por defecto para MQTT\r\nlistener 1883\r\nallow anonymous true\n"})}),"\n",(0,n.jsx)(r.p,{children:"Mientras que se deja el fichero mosquitto.conf como esta por defecto, que incluye la persistencia, el log y el enlace al directorio de configuraci\xf3n. Se omite la l\xednea"}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{children:"bind_address 0.0.0.0\n"})}),"\n",(0,n.jsx)(r.p,{children:"Porque a partir de la versi\xf3n 2.0 o superior no puede convivir con la siguiente l\xednea"}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{children:"listener 1883\n"})}),"\n",(0,n.jsx)(r.p,{children:"Es redundante, ya que al poner listerner 1883 ya permite, la versi\xf3n 2.0 o superior, la conexi\xf3n de cualquier IP a ese servicio."}),"\n",(0,n.jsx)(r.h3,{id:"ejemplo-de-testeo-del-fichero-de-configuraci\xf3n-modificado-en-mv-iiot-broker",children:"Ejemplo de testeo del fichero de configuraci\xf3n modificado en mv IIoT-broker"}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{children:'mosquitto_sub -h localhost -t "sensores/esp32/dht11" -v\r\nmosquitto_pub -h localhost -t "sensores/esp32/dht11" -m \'{"temp":22.5,"hum":58}\'\n'})}),"\n",(0,n.jsx)(r.h3,{id:"ejemplo-de-json-para-el-payload-en-arduino-para-el-esp32",children:"Ejemplo de JSON para el payload en Arduino para el ESP32"}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{children:'{\r\n  "temperatura": 27.2,\r\n  "humedad": 75,\r\n  "dispositivo": "DHT-11",\r\n  "localizacion": "office-primera-planta"\r\n}\n'})}),"\n",(0,n.jsx)(r.h3,{id:"en-telegraf",children:"En Telegraf"}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{children:'[[inputs.mqtt_consumer]]\r\n  servers = ["tcp://IP_DEL_BROKER:1883"]\r\n  topics = ["sensores/esp32/dht11"]\r\n  qos = 0\r\n  data_format = "json"\r\n  json_string_fields = ["dispositivo", "localizaci\xf3n"]\n'})}),"\n",(0,n.jsx)(r.p,{children:"Tags: dispositivo, localizaci\xf3n\r\nCampos: temperatura y humedad"}),"\n",(0,n.jsx)(r.h4,{id:"test-de-mosquitto-a-telegraf",children:"Test de Mosquitto a Telegraf"}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{children:'mosquitto_pub -h localhost -t "iot/esp32/dht11" -m \'{"temperature": 23.5, "humidity": 60, "device": "esp32-dht11", "location": "salon"}\'\r\n\n'})}),"\n",(0,n.jsx)(r.h4,{id:"comprobaci\xf3n-en-telegraf",children:"Comprobaci\xf3n en Telegraf"}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{children:"influx query 'from(bucket: \"nombre_del_bucket\") |> range(start: -5m)'\n"})})]})}function u(e={}){const{wrapper:r}={...(0,s.R)(),...e.components};return r?(0,n.jsx)(r,{...e,children:(0,n.jsx)(c,{...e})}):c(e)}},8453:(e,r,i)=>{i.d(r,{R:()=>t,x:()=>a});var o=i(6540);const n={},s=o.createContext(n);function t(e){const r=o.useContext(s);return o.useMemo((function(){return"function"==typeof e?e(r):{...r,...e}}),[r,e])}function a(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(n):e.components||n:t(e.components),o.createElement(s.Provider,{value:r},e.children)}}}]);