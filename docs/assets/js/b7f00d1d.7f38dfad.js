"use strict";(self.webpackChunkmydocs=self.webpackChunkmydocs||[]).push([[6667],{3607:(e,a,n)=>{n.r(a),n.d(a,{assets:()=>t,contentTitle:()=>d,default:()=>u,frontMatter:()=>l,metadata:()=>r,toc:()=>c});const r=JSON.parse('{"id":"Ciberseguridad/Cortafuegos/practica-iptables","title":"IPtables","description":"9881; Pr\xe1ctica IPtables","source":"@site/docs/Ciberseguridad/Cortafuegos/practica-iptables.md","sourceDirName":"Ciberseguridad/Cortafuegos","slug":"/Ciberseguridad/Cortafuegos/practica-iptables","permalink":"/me/docs/docs/Ciberseguridad/Cortafuegos/practica-iptables","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/Ciberseguridad/Cortafuegos/practica-iptables.md","tags":[],"version":"current","sidebarPosition":3,"frontMatter":{"sidebar_position":3,"title":"IPtables"},"sidebar":"tutorialSidebar","previous":{"title":"Netplan","permalink":"/me/docs/docs/Ciberseguridad/Cortafuegos/netplan"},"next":{"title":"Elastic Serch","permalink":"/me/docs/docs/Ciberseguridad/ElasticStack/elastic-search"}}');var i=n(4848),s=n(8453);const l={sidebar_position:3,title:"IPtables"},d="\u2699 Pr\xe1ctica IPtables",t={},c=[{value:"\ud83d\udcdd Pasos previos",id:"-pasos-previos",level:2},{value:"\ud83d\udee0 Configuraci\xf3n de VirtualBox",id:"-configuraci\xf3n-de-virtualbox",level:3},{value:"\ud83d\udda5 Creaci\xf3n de las m\xe1quinas virtuales",id:"-creaci\xf3n-de-las-m\xe1quinas-virtuales",level:4},{value:"\ud83d\udda5 M\xe1quina Router",id:"-m\xe1quina-router",level:3},{value:"\u2192 Habilitar el Ip Forwarding",id:"-habilitar-el-ip-forwarding",level:4},{value:"\u2192 Configuraci\xf3n de las IPs",id:"-configuraci\xf3n-de-las-ips",level:4},{value:"\ud83d\udcd6 Reglas",id:"-reglas",level:3},{value:"\ud83d\udcdd Reglas NAT",id:"-reglas-nat",level:4},{value:"\ud83d\udda5 M\xe1quina atacante",id:"-m\xe1quina-atacante",level:3},{value:"\u2192 Preparaci\xf3n de herramientas",id:"-preparaci\xf3n-de-herramientas",level:4},{value:"\ud83d\udda5 M\xe1quina Web Server",id:"-m\xe1quina-web-server",level:3},{value:"\u2192 IP est\xe1tica dentro de la LAN",id:"-ip-est\xe1tica-dentro-de-la-lan",level:4},{value:"Instalaci\xf3n Apache:",id:"instalaci\xf3n-apache",level:4},{value:"\ud83d\udda5Monitorizador",id:"monitorizador",level:3},{value:"\u2192 Herramientas de monitorizaci\xf3n",id:"-herramientas-de-monitorizaci\xf3n",level:4},{value:"\ud83d\udd01 Enrutamiento interno con IPtables",id:"-enrutamiento-interno-con-iptables",level:2},{value:"\u2192 Bloquear Fordward",id:"-bloquear-fordward",level:3},{value:"\u2192 Redirecci\xf3n NAT a Servidor Web",id:"-redirecci\xf3n-nat-a-servidor-web",level:3},{value:"\u2192 Permitir tr\xe1fico entre interfaces misma m\xe1quina",id:"-permitir-tr\xe1fico-entre-interfaces-misma-m\xe1quina",level:3},{value:"\u2192 Reenvi\xf3 en las reglas de forwarding",id:"-reenvi\xf3-en-las-reglas-de-forwarding",level:3},{value:"\u2192 Duplicar paquetes para Suricata",id:"-duplicar-paquetes-para-suricata",level:3},{value:"\u2192 Cambiar IP de origen de los paquetes de salida",id:"-cambiar-ip-de-origen-de-los-paquetes-de-salida",level:3},{value:"Resumen Final",id:"resumen-final",level:2},{value:"\ud83d\udda5 M\xe1quinas virtuales",id:"-m\xe1quinas-virtuales",level:3},{value:"\u2714Apache",id:"apache",level:3},{value:"\u2714 Suricata",id:"-suricata",level:3},{value:"\u2192 Monitorizar una interfaz",id:"-monitorizar-una-interfaz",level:4},{value:"\u2192 Actualizar suricata",id:"-actualizar-suricata",level:4},{value:"\u2192 Uso de Suricata",id:"-uso-de-suricata",level:4},{value:"\u2192 Datos de suricata",id:"-datos-de-suricata",level:4}];function o(e){const a={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,s.R)(),...e.components},{Details:n}=a;return n||function(e,a){throw new Error("Expected "+(a?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}("Details",!0),(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(a.header,{children:(0,i.jsx)(a.h1,{id:"-pr\xe1ctica-iptables",children:"\u2699 Pr\xe1ctica IPtables"})}),"\n",(0,i.jsx)(a.h2,{id:"-pasos-previos",children:"\ud83d\udcdd Pasos previos"}),"\n",(0,i.jsx)(a.h3,{id:"-configuraci\xf3n-de-virtualbox",children:"\ud83d\udee0 Configuraci\xf3n de VirtualBox"}),"\n",(0,i.jsx)(a.h4,{id:"-creaci\xf3n-de-las-m\xe1quinas-virtuales",children:"\ud83d\udda5 Creaci\xf3n de las m\xe1quinas virtuales"}),"\n",(0,i.jsx)(a.p,{children:"Crear 4 m\xe1quinas virtuales con Ubuntu Server para que sea m\xe1s liviano el entorno de pruebas."}),"\n",(0,i.jsxs)(n,{children:[(0,i.jsx)("summary",{children:(0,i.jsx)(a.p,{children:"Configuraci\xf3n del laboratorio de pruebas"})}),(0,i.jsxs)(a.ul,{children:["\n",(0,i.jsxs)(a.li,{children:[(0,i.jsx)(a.strong,{children:"MV que hace de Router"}),": 2 adaptadores de red."]}),"\n",(0,i.jsxs)(a.li,{children:[(0,i.jsx)(a.strong,{children:"MV que hace de atacante"}),": 1 adaptador red."]}),"\n",(0,i.jsxs)(a.li,{children:[(0,i.jsx)(a.strong,{children:"MV con Web Server"}),": 1 adaptador de red."]}),"\n",(0,i.jsxs)(a.li,{children:[(0,i.jsx)(a.strong,{children:"Monitorizaci\xf3n"}),": 1 adaptador de red."]}),"\n"]})]}),"\n",(0,i.jsx)(a.h3,{id:"-m\xe1quina-router",children:"\ud83d\udda5 M\xe1quina Router"}),"\n",(0,i.jsx)(a.h4,{id:"-habilitar-el-ip-forwarding",children:"\u2192 Habilitar el Ip Forwarding"}),"\n",(0,i.jsx)(a.p,{children:"Editar el archivo /etc/sysctl.conf y permitir el  reenv\xedo de paquetes"}),"\n",(0,i.jsx)(a.pre,{children:(0,i.jsx)(a.code,{className:"language-bash",children:"sudo nano /etc/sysctl.conf\n"})}),"\n",(0,i.jsx)(a.p,{children:"A continuaci\xf3n agregar o descomentar lo siguiente"}),"\n",(0,i.jsx)(a.pre,{children:(0,i.jsx)(a.code,{className:"language-bash",children:"net.ipv4.ip_forward = 1\n"})}),"\n",(0,i.jsx)(a.p,{children:"Aplicar los cambios"}),"\n",(0,i.jsx)(a.pre,{children:(0,i.jsx)(a.code,{className:"language-bash",children:"sudo sysctl -p\n"})}),"\n",(0,i.jsx)(a.h4,{id:"-configuraci\xf3n-de-las-ips",children:"\u2192 Configuraci\xf3n de las IPs"}),"\n",(0,i.jsx)(a.p,{children:"La interfaz en modo NAT usar\xe1 DHCP, la interfaz de la red interna tendr\xe1 una IP est\xe1tica."}),"\n",(0,i.jsx)(a.pre,{children:(0,i.jsx)(a.code,{className:"language-bash",children:"sudo nano /etc/netplan/01-netcfg.yaml\n"})}),"\n",(0,i.jsx)(a.pre,{children:(0,i.jsx)(a.code,{className:"language-yaml",children:"network:\n  version: 2\n  ethernets:\n    enp0s8:\n      addresses: [192.168.1.1/24]\n      dhcp4: no\n"})}),"\n",(0,i.jsx)(a.pre,{children:(0,i.jsx)(a.code,{className:"language-bash",children:"sudo netplan apply\n"})}),"\n",(0,i.jsx)(a.h3,{id:"-reglas",children:"\ud83d\udcd6 Reglas"}),"\n",(0,i.jsx)(a.h4,{id:"-reglas-nat",children:"\ud83d\udcdd Reglas NAT"}),"\n",(0,i.jsx)(a.pre,{children:(0,i.jsx)(a.code,{className:"language-bash",children:"sudo iptables -t nat -A POSTROUTING -o enp0s3 -j MASQUERADE\nsudo iptables -A FORWARD -i enp0s8 -o enp0s3 -j ACCEPT\nsudo iptables -A FORWARD -i enp0s3 -o enp0s8 -m state --state RELATED,ESTABLISHED -j ACCEPT\n"})}),"\n",(0,i.jsx)(a.h3,{id:"-m\xe1quina-atacante",children:"\ud83d\udda5 M\xe1quina atacante"}),"\n",(0,i.jsx)(a.p,{children:"Acceso a la red externa en la que est\xe1 la interfaz externa del Router y que recibe la direcci\xf3n IP por DHCP."}),"\n",(0,i.jsx)(a.h4,{id:"-preparaci\xf3n-de-herramientas",children:"\u2192 Preparaci\xf3n de herramientas"}),"\n",(0,i.jsx)(a.pre,{children:(0,i.jsx)(a.code,{className:"language-bash",children:"sudo apt install nmap hping3 netcat -y\n"})}),"\n",(0,i.jsx)(a.h3,{id:"-m\xe1quina-web-server",children:"\ud83d\udda5 M\xe1quina Web Server"}),"\n",(0,i.jsx)(a.h4,{id:"-ip-est\xe1tica-dentro-de-la-lan",children:"\u2192 IP est\xe1tica dentro de la LAN"}),"\n",(0,i.jsx)(a.pre,{children:(0,i.jsx)(a.code,{className:"language-bash",children:"sudo nano /etc/netplan/01-netcfg.yaml\n"})}),"\n",(0,i.jsx)(a.pre,{children:(0,i.jsx)(a.code,{className:"language-bash",children:"network:\n  version: 2\n  ethernets:\n    enp0s3:\n      addresses: [192.168.1.2/24] # Corchetes como alternativa a guiones\n      gateway4: 192.168.1.1\n      nameservers:\n        addresses: [8.8.8.8]\n"})}),"\n",(0,i.jsx)(a.pre,{children:(0,i.jsx)(a.code,{className:"language-bash",children:"sudo netplan apply\n"})}),"\n",(0,i.jsx)(a.h4,{id:"instalaci\xf3n-apache",children:"Instalaci\xf3n Apache:"}),"\n",(0,i.jsx)(a.pre,{children:(0,i.jsx)(a.code,{className:"language-bash",children:"sudo apt install apache2 -y\n"})}),"\n",(0,i.jsx)(a.h3,{id:"monitorizador",children:"\ud83d\udda5Monitorizador"}),"\n",(0,i.jsx)(a.h4,{id:"-herramientas-de-monitorizaci\xf3n",children:"\u2192 Herramientas de monitorizaci\xf3n"}),"\n",(0,i.jsx)(a.p,{children:"Instalar herramientas como tcpdump, iftop, nagios, zabbix."}),"\n",(0,i.jsx)(a.h2,{id:"-enrutamiento-interno-con-iptables",children:"\ud83d\udd01 Enrutamiento interno con IPtables"}),"\n",(0,i.jsx)(a.h3,{id:"-bloquear-fordward",children:"\u2192 Bloquear Fordward"}),"\n",(0,i.jsx)(a.pre,{children:(0,i.jsx)(a.code,{className:"language-bash",children:"sudo iptables -P FORWARD DROP\n"})}),"\n",(0,i.jsx)(a.h3,{id:"-redirecci\xf3n-nat-a-servidor-web",children:"\u2192 Redirecci\xf3n NAT a Servidor Web"}),"\n",(0,i.jsx)(a.p,{children:"Se procede a redirigir al puerto 80 del servidor el tr\xe1fico antes de enrutarse."}),"\n",(0,i.jsx)(a.pre,{children:(0,i.jsx)(a.code,{className:"language-bash",children:"sudo iptables -t nat -A PREROUTING -p tcp --dport 80 -i enp0s3 -j DNAT --to-destination 192.168.2.3:80 (m\xe1quina virtual con apache)\n"})}),"\n",(0,i.jsx)(a.admonition,{title:"Comprobaci\xf3n",type:"tip",children:(0,i.jsxs)(a.p,{children:["Se comprueba el acceso con curl http://IP_server_router:80, en este\ncaso es la IP del Router del ISP por DHCP (red externa a las MVs),\ncurl ",(0,i.jsx)(a.a,{href:"http://192.168.1.77:80",children:"http://192.168.1.77:80"})]})}),"\n",(0,i.jsx)(a.h3,{id:"-permitir-tr\xe1fico-entre-interfaces-misma-m\xe1quina",children:"\u2192 Permitir tr\xe1fico entre interfaces misma m\xe1quina"}),"\n",(0,i.jsx)(a.pre,{children:(0,i.jsx)(a.code,{className:"language-bash",children:"sudo iptables -A FORWARD -i enp0s8 -o enp0s3 -j ACCEPT - funciona\nsudo iptables -A FORWARD -i enp0s3 -o enp0s8 -j ACCEPT - funciona\n"})}),"\n",(0,i.jsx)(a.h3,{id:"-reenvi\xf3-en-las-reglas-de-forwarding",children:"\u2192 Reenvi\xf3 en las reglas de forwarding"}),"\n",(0,i.jsxs)(a.p,{children:["El sistema reenv\xeda el tr\xe1fico actuando como  ",(0,i.jsx)(a.strong,{children:"router"})," al haber previamente ",(0,i.jsx)(a.strong,{children:"bloqueado"})," todo tr\xe1fico con ",(0,i.jsx)(a.strong,{children:"forward drop"})," es decir se accede desde WAN al server."]}),"\n",(0,i.jsx)(a.pre,{children:(0,i.jsx)(a.code,{className:"language-bash",children:"sudo iptables -A FORWARD -p tcp -d 192.168.2.3 --dport 80 -j ACCEPT \n"})}),"\n",(0,i.jsx)(a.h3,{id:"-duplicar-paquetes-para-suricata",children:"\u2192 Duplicar paquetes para Suricata"}),"\n",(0,i.jsx)(a.pre,{children:(0,i.jsx)(a.code,{className:"language-bash",children:"sudo iptables -t mangle -A PREROUTING -i enp0s3 -p tcp --dport 80 -j TEE --gateway IP_suricata - Funciona\n"})}),"\n",(0,i.jsxs)(a.admonition,{type:"warning",children:[(0,i.jsx)(a.p,{children:"Puede ser necesario a\xf1adir el m\xf3dulo xt_TEE"}),(0,i.jsx)(a.pre,{children:(0,i.jsx)(a.code,{className:"language-bash",children:"sudo modprobe xt_TEE\n"})})]}),"\n",(0,i.jsx)(a.h3,{id:"-cambiar-ip-de-origen-de-los-paquetes-de-salida",children:"\u2192 Cambiar IP de origen de los paquetes de salida"}),"\n",(0,i.jsx)(a.p,{children:"Para que los paquetes salgan con la IP del Router"}),"\n",(0,i.jsx)(a.pre,{children:(0,i.jsx)(a.code,{className:"language-bash",children:'sudo iptables -t nat -A POSTROUTING -o enp0s8 (wan) -p tcp --sport 80  -j SNAT --to-source <IP WAN / IP p\xfablica router ".77"> \n'})}),"\n",(0,i.jsx)(a.h2,{id:"resumen-final",children:"Resumen Final"}),"\n",(0,i.jsx)(a.h3,{id:"-m\xe1quinas-virtuales",children:"\ud83d\udda5 M\xe1quinas virtuales"}),"\n",(0,i.jsx)(a.p,{children:"ubuntu server: 192.168.2.1(red interna borja) y una interfaz NAT\nubuntu apache: 192.168.2.3 y de gw la 192.168.2.1 (red interna borja)\nubuntu suricata: 192.168.2.2 y de gw la 192.168.2.1 (red interna borja)"}),"\n",(0,i.jsx)(a.h3,{id:"apache",children:"\u2714Apache"}),"\n",(0,i.jsx)(a.p,{children:"sudo apt install apache 2\nservice apache2 status (comprobar ejecuci\xf3n servicio)\nbrowser -> localhost (ver fichero index.html de apache en browser)"}),"\n",(0,i.jsx)(a.h3,{id:"-suricata",children:"\u2714 Suricata"}),"\n",(0,i.jsx)(a.pre,{children:(0,i.jsx)(a.code,{className:"language-bash",children:"sudo apt install suricata\nsuricata --build-info (comprobar instalaci\xf3n)\n/etc/suricata/suricata.yaml (fichero de configuraci\xf3n)\n"})}),"\n",(0,i.jsx)(a.h4,{id:"-monitorizar-una-interfaz",children:"\u2192 Monitorizar una interfaz"}),"\n",(0,i.jsx)(a.p,{children:'Se puede usar la etiqueta "af-packet" o "pcap", los modos de captura pueden ser "pfring, af-packet y pcap" y aunque pueden usarse la misma interfaz para todos los modos es mejor usar interfaces diferentes.'}),"\n",(0,i.jsx)(a.h4,{id:"-actualizar-suricata",children:"\u2192 Actualizar suricata"}),"\n",(0,i.jsx)(a.pre,{children:(0,i.jsx)(a.code,{className:"language-bash",children:"sudo suricata-update\n"})}),"\n",(0,i.jsx)(a.h4,{id:"-uso-de-suricata",children:"\u2192 Uso de Suricata"}),"\n",(0,i.jsx)(a.pre,{children:(0,i.jsx)(a.code,{className:"language-bash",children:"sudo suricata -c /etc/suricata/suricata.yaml -i (interface configurada)\n(previamente se ha de configurar suricata.yaml)\n"})}),"\n",(0,i.jsx)(a.h4,{id:"-datos-de-suricata",children:"\u2192 Datos de suricata"}),"\n",(0,i.jsx)(a.p,{children:"Localizados los datos recopilados por suricata en los siguientes ficheros."}),"\n",(0,i.jsx)(a.pre,{children:(0,i.jsx)(a.code,{className:"language-bash",children:"eve.json\nsuricata.fast.log\nsuricata.alert.log\n"})}),"\n",(0,i.jsx)(a.p,{children:"Que est\xe1n alojados en la siguiente ruta"}),"\n",(0,i.jsx)(a.pre,{children:(0,i.jsx)(a.code,{className:"language-bash",children:"/var/log/suricata\n"})})]})}function u(e={}){const{wrapper:a}={...(0,s.R)(),...e.components};return a?(0,i.jsx)(a,{...e,children:(0,i.jsx)(o,{...e})}):o(e)}},8453:(e,a,n)=>{n.d(a,{R:()=>l,x:()=>d});var r=n(6540);const i={},s=r.createContext(i);function l(e){const a=r.useContext(s);return r.useMemo((function(){return"function"==typeof e?e(a):{...a,...e}}),[a,e])}function d(e){let a;return a=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:l(e.components),r.createElement(s.Provider,{value:a},e.children)}}}]);